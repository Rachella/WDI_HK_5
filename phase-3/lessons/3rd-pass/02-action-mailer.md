# Sending email with Rails

Let's get a taste for sending email in Rails by adding email functionality to the PepperLunch project using Action Mailer and Mailgun.

## Getting email working

### Step 0

As always, pull changes from upstream first. Try running your Pepper Lunch app with the latest changes. What's changed?

### Sign up for Mailgun

[Mailgun](http://www.mailgun.com/) is a service that you can use to send transactional emails. Your application makes a POST request to Mailgun's servers, and its servers send an email on your behalf. Best of all, you get 10,000 emails a month for free in production (300/day in development).

(Quick aside: "transactional" emails differ from "marketing" emails in that they are triggered by some user _action_, for example: signing up, placing an order, inviting a friend. Basically, the opposite of emails sent in bulk for marketing purposes, which could be considered spam. See the link in the Resources section for more info.)

1. Visit http://www.mailgun.com and create an account.
2. You should see a success screen similar to the one below. To test that your account is able to send emails, copy and paste the example `curl` command into your terminal:
![screenshot](https://cl.ly/image/3b003b122F1W/mailgun-account-success-screen.png)
3. Check your email!

### Generate a mailer in the PepperLunch project

[Action Mailer](http://guides.rubyonrails.org/action_mailer_basics.html) is the Rails way of sending emails. Just like generating models, controllers, and scaffolds, Rails has a generator for a mailer. For now, you can think of a mailer as a controller, except instead of rendering web pages, it sends emails. Just like a controller, a mailer has views, which are templates for emails.

```ruby
rails generate mailer LunchMailer data_update_notification
```

Check out the files that are generated by this command. How does this compare to generating a scaffold? What does the `LunchMailer` part of the command do? What does the `data_update_notification` part of the command do?

### Configure your app's email settings using Mailgun

From your Mailgun homepage, click on "Domains" and then the name of your Mailgun sandbox domain. Using the settings for "Default SMTP Login" and "Default Password", open the file `config/environments/development.rb` in your app and add the following lines at the bottom:

```ruby
config.action_mailer.delivery_method = :smtp
config.action_mailer.smtp_settings = {
  :authentication => :plain,
  :address => "smtp.mailgun.org",
  :port => 587,
  :domain => "sandbox<YOUR_LONG_HEXADECIMAL_STRING>.mailgun.org",
  :user_name => "postmaster@sandbox<YOUR_LONG_HEXADECIMAL_STRING>.mailgun.org",
  :password => "<YOUR_PASSWORD>"
}
```

### Make some basic changes to the mailer

The mailer `app/mailers/lunch_mailer.rb` contains the code that sends the email. Change the default values as follows:

* Change `from@example.com` to `chefs@pepperlunch.com`
* Change `@greeting` to something like `WHY HELLO THERE VALUED CUSTOMER!`
* Change `to@example.org` to your email address.

### Run the mailer from the Rails console

Open `rails console` and type the following:

```ruby
LunchMailer.data_update_notification.deliver
```

Check your email!

### Modify the view(s)

Make some modifications to the view for the `data_update_notification` method of the `LunchMailer` mailer. It's up to you to figure out which file(s) to change. For example, you can add a sentence thanking the user for their continued patronage of Pepper Lunch.

Is there only one view for this method of the mailer? Why? (Hint: when viewing a message in Gmail, in the dropdown arrow on the right side of the sender, there's a "Show original" option.) Why send different versions of the same content?

Run `LunchMailer.data_update_notification.deliver` from the Rails console again. Check your email one more time.

### Modify the mailer method to take an argument and pass data to the view

It's not very interesting if your application always includes the same message in every email and always sends email to the same address. Modify `app/mailers/lunch_mailer.rb` so that the `data_update_notification` method takes a `user` argument. This argument is used to set a `@lunch_count` instance variable to be passed to the view, and to determine whom to email:

```ruby
def data_update_notification(user)
  @greeting = "WHY HELLO THERE"

  @lunch_count = user.lunches.count

  mail to: user.email
end
```

### Modify the view to use the data passed from the mailer

Add these lines to the bottom of the view files:

```erb
We have received your lunch tracking update!

You've eaten lunch at Pepper Lunch <%= @lunch_count %> times! Wow!
```

Let's test it out. First go to your Rails console and check how many lunches the first user has taken:

```ruby
User.first.lunches
```

If there are none, use your Pepper Lunch tracker app to record some!

Now use the same command as above in the Rails console to send an email, but this time the `data_update_notification` method of the `LunchMailer` takes an argument called `user`. So we need to pass in a user:

```
LunchMailer.data_update_notification(User.first).deliver
```

### Challenge: send the email when the user submits new lunch data

It doesn't make much sense for emails to be sent to users only when we type the command in the Rails console. Update the `LunchesController` so that every time the user submits new lunch data, they get an email notifying them of their updated lunch count.

### One last challenge: change the subject of the email

Notice the subject of the email. Did we ever set one? How did Rails decide what to use?

Use the [Action Mailer docs](http://guides.rubyonrails.org/action_mailer_basics.html) to figure out how to change the subject of the email to "Lunch tracking update!"

## Testing emails in development: letter_opener

It's been a little annoying to have to check our email every time we change something about the mailer or the view. Wouldn't it be useful to be able to preview the emails that your application would send without actually sending an email? That's what the gem `letter_opener` is for. From the [letter_opener docs](https://github.com/ryanb/letter_opener):

> Preview email in the browser instead of sending it. This means you do not need
> to set up email delivery in your development environment, and you no longer
> need to worry about accidentally sending a test email to someone else's address.

### Configure your Rails app to use letter_opener instead of SMTP

Add the gem to your Gemfile:

```
gem "letter_opener", :group => :development
```

Then run `bundle`.

Now, let's tell Rails to use `letter_opener` to send emails. Go back to `config/environments/development.rb` and change the first line we added earlier: (it's okay to leave the `smtp_settings` lines after it)

```ruby
config.action_mailer.delivery_method = :letter_opener
```

Now restart your Rails server. Try using your lunch tracker app to update your lunch count, and see what happens.

### Iterating on our email template

Now that we can iterate more rapidly, update the mailer and views to also include a bulleted list of the dates the user has eaten at Pepper Lunch. While you're at it, let's clean up the header and `@greeting` that the `generate` command included for us, if you haven't already.

## Another way to test: `mail_view`

The `mail_view` gem (built into Rails) is a tool for testing the display of an email by rendering an email view with dummy data. Unlike `letter_opener`, which intercepts emails that are sent in the normal course of using your application, `mail_view` lets you specify fake data to populate the messages with so you can focus only on testing the display of the email.

https://github.com/basecamp/mail_view

## Sending emails in production (i.e. on Heroku)

* **Checking Mailgun logs**: As part of your Mailgun dashboard, you can see logs of all messages as they are queued and then sent. This is useful to ensure your application is sending the messages you expect, both in development and production.
* Mailgun is available as a free Heroku addon: https://addons.heroku.com/mailgun
* The changes we made to `config/environments/development.rb` probably aren't going to apply when our app is running in Heroku, right? ;)

## Resources
* [Action Mailer](http://guides.rubyonrails.org/action_mailer_basics.html) - official Rails guide, with a walkthrough for creating a mailer and its views
* [Action Mailer API documentation](http://api.rubyonrails.org/v4.1.0/classes/ActionMailer/Base.html#class-ActionMailer::Base-label-Previewing+emails) - API docs with more technical and thorough description of Action Mailer
* [How To Send Automated Email In Ruby On Rails (With Mailgun)](http://www.leemunroe.com/send-automated-email-ruby-rails-mailgun/) - a simple walkthrough article
* [Mailgun](http://www.mailgun.com/) - "The Email Service For Developers"
* [`letter_opener`](https://github.com/ryanb/letter_opener)
* [`mail_view`](https://github.com/basecamp/mail_view)
* [Mailgun addon for Heroku](https://addons.heroku.com/mailgun)
* [What is transactional email?](http://blog.mailchimp.com/what-is-transactional-email/)
